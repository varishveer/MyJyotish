@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@

@{
    Layout = "Extra";
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .container {
        margin-top: 50px;
        margin-bottom: 50px;
    }

    .left-part {
        border-radius: 10px 0px 0px 10px;
        box-shadow: 0px 0px 3px 0px rgba(0, 0, 0, 0.2);
        padding: 15px;
    }

    .right-part {
        border-radius: 0px 10px 10px 0px;
        box-shadow: 0px 0px 3px 0px rgba(0, 0, 0, 0.2);
        padding: 30px;
        background-color: white;
    }

    .responsive-image {
        max-width: 100%;
        height: auto;
        border-radius: 10px;
    }

    h2 {
        margin-bottom: 20px;
        color: black;
    }

    .btn-primary {
        border-radius: 6px;
    }

    .form-group {
        margin-bottom: 0.5rem;
    }

    .form-label {
        margin-bottom: 0.2rem;
        font-size: 16px;
    }

    .input-group {
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        font-size: 12px;
    }

    .btn:not(:disabled):not(.disabled) {
        font-size: 12px;
    }

    .otpcolour {
        color: white;
        background-color: lightslategray;
    }

</style>
<div class="container h-80 ">
    <div class="row w-70">
        <div class="col-md-5 left-part d-flex justify-content-center align-items-center">
            <img src="~/gif/6300830.jpg" alt="Sign Up Image" class="responsive-image" />
        </div>
        <div class="col-md-7 right-part">
            <h2 class="mb-3 d-flex justify-content-center">Sign Up</h2>
            <form id="registrationForm">
                <div class="form-row row">
                    <div class="form-group col-md-6">
                        <label for="name" class="form-label">Name:</label>
                        <input type="text" id="name" name="name" placeholder="Enter your name" class="form-control"
                               required>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="email" class="form-label">Email:</label>
                        <div class="input-group">
                            <input type="email" id="email" name="email" class="form-control"
                                   placeholder="Enter your email" aria-label="Recipient's username" required>
                            <button class="btn btn-outline-secondary otpcolour" type="button" id="getOtp">Get OTP</button>
                        </div>
                    </div>
                </div>

                <div class="form-group col-md-12">
                    <label for="otp" class="form-label otp-label" style="display:none">Verification:</label>
                    <div class="input-group">
                        <input type="number" id="otp" name="otp" class="form-control otp-input" style="display:none"
                               placeholder="Enter OTP" required>
                        <button class="btn btn-outline-secondary otp-button" type="button" id="verifyOtp"
                                style="display:none">
                            Verify OTP
                        </button>
                    </div>
                </div>

                <div class="form-row row">
                    <div class="form-group col-md-6">
                        <label for="gender" class="form-label">Gender:</label>
                        <select id="gender" name="gender" class="form-select" required>
                            <option value="Male" selected>Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="mobile" class="form-label">Mobile:</label>
                        <input type="tel" id="mobile" name="mobile" class="form-control" placeholder="Mobile Number"
                               required>
                    </div>
                </div>

                <div class="form-row row">
                    <div class="form-group col-md-6">
                        <label for="DoB" class="form-label">Date Of Birth:</label>
                        <input type="date" class="form-control" id="DoB" name="DoB" placeholder="Enter DOB" />
                    </div>
                    <div class="form-group col-md-6">
                        <label for="PlaceOfBirthInput" class="form-label">Place of Birth:</label>
                        <input type="text" id="PlaceOfBirthInput" name="PlaceOfBirthInput" class="form-control"
                               placeholder="Enter City" />
                        <select id="PlaceOfBirthList" name="PlaceOfBirth" class="form-select mt-2" required>
                            <option value="">Select Place Of Birth</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-info">Sign Up</button>

                <div class="form-row mt-3">
                    <div class="form-group col-md-12">
                        <p>
                            By submitting this form, you agree to our
                            <a href="#" class="text-info">Privacy Policy</a> and
                            <a href="#" class="text-info">Terms of Service</a>.
                        </p>
                    </div>
                    <div class="d-flex justify-content-center">
                        <p class="mb-0">Already have an account?</p>
                        <a href="/Home/Login">Login</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>


    // Debounce function to limit API requests
    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Function to load the Place of Birth list dynamically
    async function loadPlaceOfBirth(city) {
        if (!city) return;

        try {
            const response = await fetch(BaseUrl + `Api/Account/PlaceOfBirthList?City=${encodeURIComponent(city)}`);
            const data = await response.json();
            const $placeOfBirthDropdown = $('#PlaceOfBirthList');
            $placeOfBirthDropdown.html('<option value="">Select Place Of Birth</option>');

            data.data.forEach(placeOfBirth => {
                $placeOfBirthDropdown.append(`<option value="${placeOfBirth}">${placeOfBirth}</option>`);
            });
        } catch (error) {
            console.error('Error fetching PlaceOfBirth:', error);
        }
    }

    // Trigger API call on every keypress in the PlaceOfBirth input
    $('#PlaceOfBirthInput').on('keyup', debounce(function () {
        const city = $(this).val();
        loadPlaceOfBirth(city);
    }, 300));

    // Get OTP button click event
    $("#getOtp").click(function () {
        Swal.fire({
            title: "Processing Your Request",
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        })
        const email = $('#email').val();

        $.ajax({
            url: BaseUrl + `Api/Account/RegisterUserEmail?email=${encodeURIComponent(email)}`,
            type: 'POST',
            success: function () {
               Swal({
                   title:"success",
                   text:"OTP send successfully",
                   icon:"success",
                   didClose:()=>{
                        $("#otp").show();
                        $("#verifyOtp").show();
                   }
               })
               
            },
            error: function (xhr) {
                Swal({
                    title: "error",
                    text: xhr.statusText,
                    icon: "error"
                })
              
            }
        });
    });

    // Verify OTP button click event
    $("#verifyOtp").click(function () {
        Swal.fire({
            title: "Processing Your Request",
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        })
        const email = $('#email').val();
        const otp = $('#otp').val();

        const data = { Email: email, Otp: otp };

        $.ajax({
            url: BaseUrl + `Api/Account/VerifyUserOtp`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {

                Swal({
                    title: "success",
                    text: "OTP verified successfully",
                    icon: "success",
                    didClose: () => {
                        $("#otp").hide();
                        $("#verifyOtp").hide();
                    }
                })

            },
            error: function (xhr) {
                 
                Swal({
                    title: "error",
                    text: xhr.statusText,
                    icon: "error"
                })
            }
        });
    });

    // Form submission event
    $('#registrationForm').on("submit", function (event) {
        event.preventDefault();
        Swal.fire({
            title: "Processing Your Request",
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        })
        const formData = {
            email: $('#email').val(),
            mobile: $('#mobile').val(),
            name: $('#name').val(),
            gender: $('#gender').val(),
            DoB: $('#DoB').val().split('-').reverse().join('-'), 
            PlaceOfBirth: $('#PlaceOfBirthList').val(),
            otp: $('#otp').val()
        };
        console.log(formData);
        $.ajax({
            url: BaseUrl + 'Api/Account/RegisterUserDetails',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response) {
                if (response.status === 200) {
                    Swal({
                        title: "success",
                        text: "Registered Successfully",
                        icon: "success",
                        didClose: () => {
                            window.location.href = "/Home/Index";
                        }
                    })
                }
                else {
                    Swal({
                        title: "error",
                        text: response.message,
                        icon: "error"
                    })
                }
                           
            },
            error: function (xhr) {
                alert('Error: ' + xhr.status + ' - ' + xhr.statusText);
            }
        });
    });
</script>

