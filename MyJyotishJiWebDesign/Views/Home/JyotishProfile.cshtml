
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<style>
    .bg-light-sec{
        background: #d2e2fc !important;
        background-blend-mode:darken;
    }
</style>

<div class="container" style="margin-top:100px; background-color: #f7f7f7; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
    <div class="card shadow-sm" style="background-color: #ffffff; padding: 20px; border-radius: 10px;">
        <div class="card-body">
            <div class="row align-items-center mb-4">
                <div class="col-md-3 text-center text-md-start">
                    <img id="profilePicture" src="" alt="Profile Picture" class="rounded-circle img-thumbnail" style="width: 100%; max-width: 120px; border: 2px solid #ffffff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);">
                </div>
                <div class="col-md-9">
                    <h2 id="profileName" class="h4 mb-1" style="color: #333333;"> <span class="text-success">&#10004;</span></h2>
                    <span class="text-warning me-2">★★★★★</span>
                     <span id="rating" class="mb-0 me-2">4.99</span>|
                    <span id="totalReviews" class="text-muted">
                     (6587 total)</span>
                    <p id="profileExpertise" class="text-muted mb-1" style="font-size: 14px;"></p>
                    <p id="profileLanguage" class="text-muted mb-1" style="font-size: 14px;"></p>
                    <p id="profileExperience" class="text-muted mb-1" style="font-size: 14px;"></p>
                    <p id="profileCharges" class="text-secondary fw-bold mb-1" style="font-size: 18px;"></p>
                    <div class="mt-3">

                        <button class="btn btn-primary me-2 mb-2 mb-md-0" style="background-color: #4CAF50; border-color: #4CAF50;">Start Chat</button>
                        <button class="btn btn-primary" style="background-color: #4CAF50; border-color: #4CAF50;">Start Call</button>
                        <button class="btn btn-primary" style="background-color: #4CAF50; border-color: #4CAF50;" data-bs-toggle="modal" data-bs-target="#exampleModal">Book A Appointmnet</button>
                    </div>
                  

                </div>
            </div>

            <div class="mb-4">
                <h3 class="h5 border-bottom" style="color: #333333;">About me</h3>
                <p id="aboutMe" class="text-justify" style="font-size: 14px;"></p>
            </div>

            <div class="mb-4" id="ratingSection">
                <div class="d-flex align-items-center">
                   
                </div>
                <div class="mt-3" id="reviewsSection">
                    <!-- Add reviews here -->
                </div>
            </div>

            <div class="mb-4">
                <h3 class="h5 border-bottom" style="color: #333333;">Gallery</h3>
                <div class="row g-2" id="gallerySection">
                    <!-- Gallery images will be dynamically loaded here -->
                </div>
            </div>

            <div class="mb-4">
                <h3 class="h5 border-bottom" style="color: #333333;">Videos</h3>
                <div id="videosSection" class=" row">
                    <!-- Videos will be dynamically loaded here -->
                </div>
            </div>

            <div class="mb-4">
                <h3 class="h5 border-bottom" style="color: #333333;">Check Similar Consultants</h3>
                <div class="row g-2">
                    <!-- Similar consultants section -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Book An Appoinment</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select class="form-select my-2" id="appoinmentDate">
                </select>
                <div id="appoinmentDetail"></div>
                <div id="problem">
                    <textarea class="form-control" id="problem-desc" placeholder="Describe Your Problem"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" id="prev-btn">Previous</button>
                <button class="btn btn-primary" disabled id="next-btn">Next</button>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function () {
       


        debugger;
        const urlParams = new URLSearchParams(window.location.search);
        var astrologerId = urlParams.get('Id');
        var apiUrl = BaseUrl + `Api/User/AstrologerProfile?Id=${astrologerId}`;
        $.ajax({
            url: apiUrl,
            method: 'GET',
            success: function (response) {
                debugger;
                if (response.status === 200) {
                    var data = response.data;

                    // Update Profile Section
                    $('#profilePicture').attr('src', BaseUrl+data.profileImageUrl);
                    $('#profileName').text(data.name + ' ✅');
                    $('#profileExpertise').text(data.expertise);
                    $('#profileLanguage').text(data.language);
                    $('#profileExperience').text('Experience: ' + data.experience + ' Years');
                    $('#profileCharges').text('₹ ' + data.chatCharges + ' / 20 min');
                    $('#bookAAppointment').attr('href', "/Home/JyotishProfile?Id=" + `${data.id}`);
                    // Update About Section
                    $('#aboutMe').text(data.about);

                    // Update Gallery Section
                    var galleryHtml = '';
                    $.each(data.gallery, function (index, item) {
                        galleryHtml += '<div class="col-6 col-md-3">';
                        galleryHtml += '<img src="'  + BaseUrl+ item.imageUrl + '" alt="Gallery Image" class="img-fluid rounded-4 img-thumbnail border-0" style="height:250px; width:250; border: 2px solid #ffffff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);">';
                        galleryHtml += '</div>';
                    });
                    $('#gallerySection').html(galleryHtml);

                    // Update Videos Section
                    var videosHtml = '';
                    $.each(data.videos, function (index, video) {
                        videosHtml += '<div class="col-4"> <iframe class="img-fluid rounded-4 img-thumbnail border-0" style="height:250px; border: 2px solid #ffffff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);"  src="' + video.videoUrl + '" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> </div>';
                    });
                    $('#videosSection').html(videosHtml);

                    // Update Rating & Reviews Section
                    $('#rating').text(data.rating!=null?data.rating:0.0 || '4.99'); // Placeholder for rating
                    $('#totalReviews').text('(6587 total)'); // Placeholder for total reviews
                    // Add reviews dynamically if you have review data
                } else {
                    console.error('Error fetching data: ', response.message);
                }
            },
            error: function (error) {
                debugger;
                console.error('AJAX Error: ', error);
            }
        });


        // select appoinment
        function reverseDate(dateString) {
            const parts = dateString.split('-');

            const reversedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;

            return reversedDate;
        }
        var appoinmentUrl = BaseUrl + `api/User/getAllAppointmentSlot?Id=${astrologerId}`;
        let appoinmentArray;
        $.ajax({
            url: appoinmentUrl,
            method: 'GET',
            success: function (response) {
                $("#problem").hide()
                $("#prev-btn").hide()
                debugger;
                if (response.status === 200) {

                    var data = response.data;
                    appoinmentArray = data;
                    console.log(data)
                    $("#appoinmentDate").append(`
                            <option disabled>--Select Appoinment Date--</option>

                                `)
                    data.forEach(function (d, i) {
                       
                        $("#appoinmentDate").append(
                            `
                                    <option ${i == 0 ? "selected" : ""} value='${d.date}'>${reverseDate(d.date.split("T")[0])}</option>
                            `
                        )
                    })
                }
            }, error: function (err) {
                console.log(err)
            }
        }).then(() => {

            let newArray = [];
            function setAppoinment(appdata) {
                newArray = appoinmentArray.filter((e) => {
                    return e.date == appdata;
                })

                console.log(newArray)
                $("#appoinmentDetail").empty();
                newArray[0].slotList.forEach(function (d) {
                    $("#appoinmentDetail").append(
                        `<label class='w-100'>
                           <div class='d-flex bg-light-sec border rounded text-secondary fw-semi-bold my-2 p-2 justify-content-between align-items-center'>
                                   <div class='row w-100'>
                                   <div class='col-sm-1'>
                                           <input type='radio' name='jyotishAppoinment' data-userId='${localStorage.getItem('userId')}' data-slotId='${d.id}' data-jyotishId='${d.jyotishId}'>
                                   </div>
                                       
                                           <div class='col-sm-5'>

                               <span> ${d.timeFrom
                        } - ${d.timeTo} </span>
                           </div>
                                               <div class='col-sm-4'>
                           <span class=''>Time :&nbsp;${d.timeDuration}min</span>
                           </div>
                           </div>
                           </div>
                           </label>
                        `
                    )
                })
            }
            $("#appoinmentDate").on("change", function () {
                setAppoinment($(this).val())
            });
            setAppoinment($("#appoinmentDate").val())

            document.querySelectorAll('input[name="jyotishAppoinment"]').forEach(radio => {
                radio.addEventListener('change', function(){
                    $("#next-btn").attr("disabled",false)
                });
            });

            $("#next-btn").click(function(){
                if($(this).text()=="Book"){
                bookAppoinment()
                }else{
                $("#problem").show()
                $("#prev-btn").show()
                $("#appoinmentDetail").hide()
$(this).text("Book");
                }
            })

            $("#prev-btn").click(function(){
                $("#problem").hide()
                $("#prev-btn").hide()
                $("#appoinmentDetail").show()
$("#next-btn").text("Next");
            });


        var bookAppoinmentUrl = BaseUrl + `api/User/bookAppointment`;
            function bookAppoinment(){
                Swal.fire({
  title: "Are you sure?",
  text: "Do you really want to book!",
  icon: "warning",
  showCancelButton: true,
  confirmButtonColor: "#3085d6",
  cancelButtonColor: "#d33",
  confirmButtonText: "Yes"
}).then((result) => {
  if (result.isConfirmed) {
    
                Swal.fire({
  title: "Proccessing Please Wait!",
  timerProgressBar: true,
  didOpen: () => {
    Swal.showLoading();
  }
                })
                let appointmentDetail = $("input[name='jyotishAppoinment']:checked");

                let userId=appointmentDetail[0].getAttribute("data-userId")
                let jyotishId=appointmentDetail[0].getAttribute("data-jyotishId")
                let slotId=appointmentDetail[0].getAttribute("data-slotId")
                let problem=$("#problem-desc").val()
                debugger
                 $.ajax({
    url: bookAppoinmentUrl,
    method: 'POST',
    contentType: 'application/json',  
    data: JSON.stringify({
        userId: userId,
        jyotishId: jyotishId,
        slotId: slotId,
        problem: problem
    }),
    success: function(res) {
        debugger
       if(res.status==200){
           Swal.fire({
      title: "Success!",
      text: res.message,
      icon: "success"
    });
    $("#exampleModal").modal("hide")
    $("#problem").hide()
                $("#prev-btn").hide()
                $("#appoinmentDetail").show()
$("#next-btn").text("Next");
       }else{
            Swal.fire({
      title: "error!",
      text: res.message,
      icon: "error"
       })
       }
    },
    error: function(err) {
        Swal.fire({
      title: "error!",
      text: "An error occured please try again later",
      icon: "error"
       })
    }
                 
});
  }
});
            }

           
            })

    });

</script>





