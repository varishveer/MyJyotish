@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "AdminLayout";
}




<link href="https://cdn.datatables.net/2.1.3/css/dataTables.dataTables.min.css" rel="stylesheet" />
<script src="https://cdn.datatables.net/2.1.3/js/dataTables.min.js"></script>

<div class="container-fluid pt-4 px-4">
    <div class="bg-light text-center rounded p-4">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h6 class="mb-0">Appointments</h6>
        </div>
        <div id="buttonContainer1">
        </div>
        <div class="table-responsive">


            <table id="DataTable" class="table text-start align-middle table-bordered table-hover mb-0" style="width:100%;">
                <!-- Table headers will be inserted dynamically -->
            </table>
        </div>
    </div>
</div>

<!-- Include jQuery -->



<script>
    $(document).ready(function () {
        function fetchData() {
            $.ajax({
                url: "https://localhost:7118/api/Admin/Appointment",
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem("Token")}`,
                    'Content-Type': 'application/json',
                },
                success: function (result) {
                    console.log(result); // Log the API response
                    let htmls = '<thead><tr><th>Id</th><th>Name</th><th>Mobile</th><th>Date Time</th><th>Email</th><th>Jyotish Id</th><th>User Id</th><th>Problem</th><th>Solution</th><th>Status</th><th>Amount</th><th>Action</th></tr></thead><tbody>';

                    $.each(result.data, function (key, item) {
                        htmls += '<tr data-id="' + item.id +
                            '" data-name="' + item.name +
                            '" data-mobile="' + item.mobile +
                            '" data-datetime="' + item.dateTime +
                            '" data-email="' + item.email +
                            '" data-jyotishid="' + item.jyotishId +
                            '" data-userid="' + item.userId +
                            '" data-problem="' + item.problem +
                            '" data-solution="' + item.solution +
                            '" data-status="' + item.status +
                            '" data-amount="' + item.amount + '">';
                        htmls += `<td class="text-center">${item.id}</td>`;
                        htmls += `<td class="text-center">${item.name}</td>`;
                        htmls += `<td class="text-center">${item.mobile}</td>`;
                        htmls += `<td class="text-center">${item.dateTime}</td>`;
                        htmls += `<td class="text-center">${item.email}</td>`;
                        htmls += `<td class="text-center">${item.jyotishId}</td>`;
                        htmls += `<td class="text-center">${item.userId}</td>`;
                        htmls += `<td class="text-center">${item.problem}</td>`;
                        htmls += `<td class="text-center">${item.solution}</td>`;
                        htmls += `<td class="text-center">${item.status}</td>`;
                        htmls += `<td class="text-center">${item.amount}</td>`;
                        htmls += `<td class="text-center">
                                    <svg class="open-modal" data-bs-toggle="modal" data-bs-target="#updateModal" xmlns="http://www.w3.org/2000/svg" width="1.13em" height="1em" viewBox="0 0 576 512"><path fill="currentColor" d="m402.6 83.2l90.2 90.2c3.8 3.8 3.8 10 0 13.8L274.4 405.6l-92.8 10.3c-12.4 1.4-22.9-9.1-21.5-21.5l10.3-92.8L388.8 83.2c3.8-3.8 10-3.8 13.8 0m162-22.9l-48.8-48.8c-15.2-15.2-39.9-15.2-55.2 0l-35.4 35.4c-3.8 3.8-3.8 10 0 13.8l90.2 90.2c3.8 3.8 10 3.8 13.8 0l35.4-35.4c15.2-15.3 15.2-40 0-55.2M384 346.2V448H64V128h229.8c3.2 0 6.2-1.3 8.5-3.5l40-40c7.6-7.6 2.2-20.5-8.5-20.5H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V306.2c0-10.7-12.9-16-20.5-8.5l-40 40c-2.2 2.3-3.5 5.3-3.5 8.5"/></svg>
                        </td>`;
                        htmls += '</tr>';
                    });

                    htmls += '</tbody>';
                    $('#DataTable').html(htmls);
                    $('#DataTable').DataTable(); // Initialize after setting the HTML
                },
                error: function (errormessage) {
                    console.error('Error fetching data:', errormessage.responseText);
                }
            });
        }

        fetchData(); // Call the function to load data
    });
</script>





<!-- Bootstrap Modal -->
@* <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Update Appointment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="requestForm">
                    <div class="form-group">
                        <label for="Id">Id:</label>
                        <input type="text" class="form-control" id="Id" hidden>
                    </div>
                    <div class="form-group">
                        <label for="Mode">Mode:</label>
                        <input type="text" class="form-control" id="Mode">
                    </div>
                    <div class="form-group">
                        <label for="Name">Name:</label>
                        <input type="text" class="form-control" id="Name">
                    </div>
                    <div class="form-group">
                        <label for="Mobile">Mobile:</label>
                        <input type="text" class="form-control" id="Mobile">
                    </div>
                    <div class="form-group">
                        <label for="DateTime">DateTime:</label>
                        <input type="text" class="form-control" id="DateTime">
                    </div>
                    <div class="form-group">
                        <label for="Email">Email:</label>
                        <input type="text" class="form-control" id="Email">
                    </div>
                    <div class="form-group">
                        <label for="JyotishId">JyotishId:</label>
                        <input type="text" class="form-control" id="JyotishId">
                    </div>
                    <div class="form-group">
                        <label for="UserId">UserId:</label>
                        <input type="text" class="form-control" id="UserId">
                    </div>
                    <div class="form-group">
                        <label for="Problem">Problem:</label>
                        <input type="text" class="form-control" id="Problem">
                    </div>
                    <div class="form-group">
                        <label for="Solution">Solution:</label>
                        <input type="text" class="form-control" id="Solution">
                    </div>
                    <div class="form-group">
                        <label for="Status">Status:</label>
                        <input type="text" class="form-control" id="Status">
                    </div>
                    <div class="form-group">
                        <label for="Amount">Amount:</label>
                        <input type="number" class="form-control" id="Amount">
                    </div>
                    <button type="button" class="btn btn-primary" id="updateButton">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>
 *@
<!-- SVG Icon to Trigger Modal -->


<!-- Modal Structure -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Update Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="requestForm">
                    <div class="form-group">
                        <label for="Id">Id:</label>
                        <input type="text" class="form-control" id="Id" readonly>
                    </div>
                   
                    <div class="form-group">
                        <label for="Name">Name:</label>
                        <input type="text" class="form-control" id="Name">
                    </div>
                    <div class="form-group">
                        <label for="Mobile">Mobile:</label>
                        <input type="text" class="form-control" id="Mobile">
                    </div>
                    <div class="form-group">
                        <label for="DateTime">DateTime:</label>
                        <input type="text" class="form-control" id="DateTime">
                    </div>
                    <div class="form-group">
                        <label for="Email">Email:</label>
                        <input type="text" class="form-control" id="Email">
                    </div>
                    <div class="form-group">
                        <label for="JyotishId">JyotishId:</label>
                        <input type="text" class="form-control" id="JyotishId">
                    </div>
                    <div class="form-group">
                        <label for="UserId">UserId:</label>
                        <input type="text" class="form-control" id="UserId">
                    </div>
                    <div class="form-group">
                        <label for="Problem">Problem:</label>
                        <input type="text" class="form-control" id="Problem">
                    </div>
                    <div class="form-group">
                        <label for="Solution">Solution:</label>
                        <input type="text" class="form-control" id="Solution">
                    </div>
                    <div class="form-group">
                        <label for="Status">Status:</label>
                        <input type="text" class="form-control" id="Status">
                    </div>
                    <div class="form-group">
                        <label for="Amount">Amount:</label>
                        <input type="number" class="form-control" id="Amount">
                    </div>
                    <button type="button" class="btn btn-primary" id="updateButton">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).on('click', '.open-modal', function () {
        // Get the closest row that contains the SVG
        const row = $(this).closest('tr');
        const id = row.data('id');
        const mode = row.data('mode'); // Ensure mode data is set if needed
        const name = row.data('name');
        const mobile = row.data('mobile');
        const datetime = row.data('datetime');
        const email = row.data('email');
        const jyotishId = row.data('jyotishid');
        const userId = row.data('userid');
        const problem = row.data('problem');
        const solution = row.data('solution');
        const status = row.data('status');
        const amount = row.data('amount');

        // Populate modal fields
        $('#Id').val(id);
        $('#Mode').val(mode); // Ensure you set this or remove if not needed
        $('#Name').val(name);
        $('#Mobile').val(mobile);
        $('#DateTime').val(datetime);
        $('#Email').val(email);
        $('#JyotishId').val(jyotishId);
        $('#UserId').val(userId);
        $('#Problem').val(problem);
        $('#Solution').val(solution);
        $('#Status').val(status);
        $('#Amount').val(amount);
    });




    document.getElementById('updateButton').addEventListener('click', async function () {
        // Get form data
        const formData = {
            Id: parseInt(document.getElementById('Id').value, 10),
          
            Name: document.getElementById('Name').value,
            Mobile: document.getElementById('Mobile').value,
            DateTime: new Date(document.getElementById('DateTime').value).toISOString(), // Convert to ISO string
            Email: document.getElementById('Email').value,
            JyotishId: parseInt(document.getElementById('JyotishId').value, 10),
            UserId: parseInt(document.getElementById('UserId').value, 10),
            Problem: document.getElementById('Problem').value,
            Solution: document.getElementById('Solution').value,
            Status: document.getElementById('Status').value,
            Amount: parseInt(document.getElementById('Amount').value, 10)
        };

        try {
            const response = await fetch('https://localhost:7118/api/Admin/UpdateAppointment', {
                method: 'POST', // Use 'PUT' if updating an existing resource
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem("Token")}`, // Example authorization header
                    'Content-Type': 'application/json' // Header indicating JSON payload
                },
                body: JSON.stringify(formData) // Convert form data to JSON
            });

            if (response.status === 200) {
                const result = await response.json();
                alert('Request updated successfully!');
                console.log(result);
                $('#updateModal').modal('hide'); // Close the modal
                window.location.reload();

            } else {
                alert('Failed to update request.');
                console.error('Error:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while updating the request.');
        }
    });
</script>