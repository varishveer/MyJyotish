@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "AdminLayout";

}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    .image-container {
        border: 1px solid #ddd;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 1rem;
        height: 140px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s ease, transform 0.3s ease;
        background-color: white !important;
    }

        .image-container img {
            max-width: 100%;
            max-height: 120px; /* Limit image height */
            object-fit: cover;
        }

        .image-container:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
        }

        .image-container label {
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }

    #loading {
        display: none;
        margin-bottom: 1rem;
        text-align: center;
        font-size: 1.2rem;
    }

    .row {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
    }

    .col-md-6,
    .col-lg-4 {
        flex: 1 0 30%;
        max-width: 30%;
        margin-bottom: 1rem;
    }

        .col-md-6.increased-width,
        .col-lg-4.increased-width {
            flex: 1 0 35%;
            max-width: 45%;
        }

    @@media (max-width: 768px) {
        .col-md-6 {
            flex: 1 0 45%;
            max-width: 45%;
        }

            .col-md-6.increased-width {
                flex: 1 0 50%;
                max-width: 50%;
            }
    }

    @@media (max-width: 576px) {
        .col-md-6 {
            flex: 1 0 100%;
            max-width: 100%;
        }

            .col-md-6.increased-width {
                flex: 1 0 100%;
                max-width: 100%;
            }
    }

    .main-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
    }

    .img-text {
        display: flex;
        justify-content: center;
    }
</style>
<style>
    /* For screens smaller than 576px (mobile) */
    @@media (max-width: 575.98px) {
        .container {
            padding: 0 15px;
        }

        .row {
            display: block;
        }

        .col-md-3 {
            width: 100% !important;
            margin-bottom: 15px;
        }

        .img-text {
            font-size: 14px;
        }
    }

    /* For screens between 576px and 768px (tablets) */
    @@media (min-width: 576px) and (max-width: 767.98px) {
        .col-md-3 {
            width: 50% !important;
            margin-bottom: 15px;
        }
    }

    /* For screens between 768px and 991px (medium to large tablets or small laptops) */
    @@media (min-width: 768px) and (max-width: 991.98px) {
        .col-md-3 {
            width: 33.33% !important;
        }
    }

    /* For screens above 992px (desktop) */
    @@media (min-width: 992px) {
        .col-md-3 {
            width: 20% !important;
        }
    }

    .approved{
        color: green;
        font-size: 24px;
        cursor: pointer;
    }
    .rejected{
        color: red;
        font-size: 24px;
        cursor:pointer;
    }
</style>
@{
   
}
<div class="container-fluid pt-4 px-4">
    <div class=" text-center  border border-1 rounded p-3">

        <div class="row">
            <div class="col-md-12 d-flex justify-content-center mb-3 fw-bold fs-2 text-primary">
                <div>Jyotish Documents</div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3 col-lg-2 mb-4 increased-width">
                <div class="image-container bg-light rounded">
                    <img id="idProof" alt="ID Proof" class="img-fluid" src="">
                </div>
                <div class="img-text mb-2">
                    <span style="font-weight:bold">Status:&nbsp; </span>

                    <span id="idProofStatus"> </span>

                </div>
                <div class="flex-row">
                    <i class="fas fa-check-circle approved" data-toggle="modal" data-target="#exampleModal" data-whatever="John Doe"  title="Approved"></i>&nbsp;
                    <i class="fas fa-times-circle rejected" data-toggle="modal" data-target="#rejectedModal" title="Rejected"></i>
                </div>

            </div>
            <div class="col-md-3 col-lg-2 mb-4 increased-width">
                <div class="image-container bg-light rounded">
                    <img id="addressProof" alt="Address Proof" src="">
                </div>
                <div class="img-text mb-2">
                    <span style="font-weight:bold">Status:&nbsp; </span>

                    <span  id="addressProofStatus"> </span>
                    

                </div>
                <div class="flex-row">
                    <i class="fas fa-check-circle approved" data-toggle="modal" data-target="#exampleModal" data-whatever="John Doe"  title="Approved"></i>&nbsp;
                    <i class="fas fa-times-circle rejected" data-toggle="modal" data-target="#rejectedModal" title="Rejected"></i>
                </div>
            </div>
            <div class="col-md-3 col-lg-2 mb-4 increased-width">
                <div class="image-container bg-light rounded">
                    <img id="tenthCertificate" alt="Tenth Certificate" src="">
                </div>
                <div class="img-text mb-2">
                    <span style="font-weight:bold">Status:&nbsp; </span>

                    <span id="tenthCertificateStatus"> </span>
                </div>
                <div class="flex-row">
                    <i class="fas fa-check-circle approved" data-toggle="modal" data-target="#exampleModal" data-whatever="John Doe"  title="Approved"></i>&nbsp;
                    <i class="fas fa-times-circle rejected" data-toggle="modal" data-target="#rejectedModal" title="Rejected"></i>
                </div>
            </div>
            <div class="col-md-3 col-lg-2 mb-4 increased-width">
                <div class="image-container bg-light rounded">
                    <img id="twelveCertificate" alt="Twelve Certificate" src="">
                </div>
                <div class="img-text mb-2">
                    <span style="font-weight:bold">Status:&nbsp; </span>

                    <span id="twelveCertificateStatus"> </span>
                </div>
                <div class="flex-row">
                    <i class="fas fa-check-circle approved" data-toggle="modal" data-target="#exampleModal" data-whatever="John Doe"  title="Approved"></i>&nbsp;
                    <i class="fas fa-times-circle rejected" data-toggle="modal" data-target="#rejectedModal" title="Rejected"></i>
                </div>
            </div>
            <div class="col-md-3 col-lg-2 mb-4 increased-width">
                <div class="image-container bg-light rounded">
                    <img id="professionalCertificate" alt="Professional Certificate" src="">
                </div>
                <div class="img-text mb-2">
                    <span style="font-weight:bold">Status:&nbsp; </span>

                    <span id="professionalCertificateStatus"> </span>
                </div>
                <div class="flex-row">
                    <i class="fas fa-check-circle approved" data-toggle="modal" data-target="#exampleModal" data-whatever="John Doe"  title="Approved"></i>&nbsp;
                @*     <i class="fas fa-times-circle rejected" title="Rejected"></i> *@
                    <i class="fas fa-times-circle rejected" data-toggle="modal" data-target="#rejectedModal"title="Rejected"></i>

                </div>
            </div>
        </div>
    </div>
</div>


<!--Approved Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Approved message</h5>
                <button type="button" class="close btn text-danger" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Subject:</label>
                        <input type="text" class="form-control" id="recipient-name" >
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">Message:</label>
                        <textarea class="form-control" id="message-text" style="resize:none;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="approvedBtn" type="button" class="btn btn-primary">Send message</button>
            </div>
        </div>
    </div>
</div>


<script>

    $('#exampleModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); 
        var recipient = button.data('whatever'); 

        var modal = $(this);
        modal.find('.modal-title').text('New message to ' + recipient); // Update modal title
        modal.find('.modal-body input').val(recipient); // Update recipient input field
    });
</script>
<!--Approved Modal End -->

<div class="modal fade" id="rejectedModal" tabindex="-1" role="dialog" aria-labelledby="rejectedModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Rejected message</h5>
                <button type="button" class="close btn text-danger" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Subject:</label>
                        <input type="text" class="form-control" id="recipient-name">
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">Message:</label>
                        <textarea class="form-control" id="message-text" style="resize:none;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="rejectBtn" type="button" class="btn btn-primary">Send message</button>
            </div>
        </div>
    </div>
</div>






<script>
    $(document).ready(function () {

        // Function to get 'id' from the URL parameters
        function getIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id'); // Get the value of 'id' param
        }

        var id = getIdFromUrl(); // Get the ID from the URL

        if (id) {
            // Function to get Jyotish documents using Ajax
            function getJyotishDocs(id) {
                $.ajax({
                    url: BaseUrl + `Api/Admin/GetJyotishDocs?Id=${id}`,
                    type: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem("Token")}`
                    },
                    success: function (response) {
                        debugger;
                        if (response.status === 200) {
                            updateDocumentStatus(response.data); // Call function to update document status
                        } else {
                            alert("No Record Found");
                            window.location.replace("/Admin/PendingJyotish");
                        }
                    },
                    error: function () {
                        alert('Error fetching Jyotish documents.');
                        window.location.replace("/Admin/PendingJyotish");
                    }
                });
            }

            // Function to update document status in the UI
            function updateDocumentStatus(docs) {
                $("#idProof").attr("src", docs.idProof? BaseUrl + docs.idProof : '/Img/SampleDoc.jpeg');
                updateStatus("idProofStatus", docs.idProofStatus, "idProof");

                $("#addressProof").attr("src",docs.addressProof? BaseUrl + docs.addressProof : '/Img/SampleDoc.jpeg');
                updateStatus("addressProofStatus", docs.addressProofStatus, "addressProof");

                $("#tenthCertificate").attr("src", docs.tenthCertificate? BaseUrl + docs.tenthCertificate : '/Img/SampleDoc.jpeg');
                updateStatus("tenthCertificateStatus", docs.tenthCertificateStatus, "tenthCertificate");

                $("#twelveCertificate").attr("src", docs.twelveCertificate ? BaseUrl + docs.twelveCertificate : '/Img/SampleDoc.jpeg');
                updateStatus("twelveCertificateStatus", docs.twelveCertificateStatus, "twelveCertificate");

                $("#professionalCertificate").attr("src", docs.professionalCertificate ? BaseUrl + docs.professionalCertificate : '/Img/SampleDoc.jpeg');
                updateStatus("professionalCertificateStatus", docs.professionalCertificateStatus, "professionalCertificate");
            }

            // Function to update status text and assign data-status to the buttons
            function updateStatus(elementId, status, docType) {
             
                if (status == null) { status = "Not Uploaded Yet"; }
                $("#" + elementId).text(status);
               
                $("#" + docType).data('status', status); // Store status in data attribute for use later
            }

            // Call the function to get Jyotish Docs when the page loads
            getJyotishDocs(id);

            // Event listener for Approve button (open modal)
            $(document).on("click", ".approved", function () {
                var imageContainer = $(this).closest('.col-md-3, .col-lg-2');
                var docType = imageContainer.find('img').attr('id'); // Get the ID from the image element
                var status = $("#" + docType + "Status").text(); // Get the status from the span element
                openModal('Approved', docType, status); // Open the modal with the correct values
            });

            // Event listener for Reject button (open modal)
            $(document).on("click", ".rejected", function () {
                var imageContainer = $(this).closest('.col-md-3, .col-lg-2');
                var docType = imageContainer.find('img').attr('id'); // Get the ID from the image element
                var status = $("#" + docType + "Status").text(); // Get the status from the span element
                openModal('Rejected', docType, status); // Open the modal with the correct values
            });

            // Function to open the modal and set data
            function openModal(action, docType, status) {
                var modal = action === 'Approved' ? $('#exampleModal') : $('#rejectedModal');
                modal.find('.modal-title').text(`${action} message for ${docType}`);
                modal.find('.modal-body input').val(`${docType} ${action}`); // Set the subject
                modal.modal('show'); // Show the modal
            }

            // Use event delegation for the approve button inside the modal
            $(document).on('click', '#approvedBtn', function () {
                var modal = $('#exampleModal');
                var docType = modal.find('.modal-title').text().split(' ')[3]; // Extract the document type from the modal title
                var subject = modal.find('#recipient-name').val(); // Get subject
                var message = modal.find('#message-text').val(); // Get message

                // Call API to update status
                sendStatusUpdate(docType, 'Approved', subject, message);
            });

            // Use event delegation for the reject button inside the modal
            $(document).on('click', '#rejectBtn', function () {
                var modal = $('#rejectedModal');
                var docType = modal.find('.modal-title').text().split(' ')[3]; // Extract the document type from the modal title
                var subject = modal.find('#recipient-name').val(); // Get subject
                var message = modal.find('#message-text').val(); // Get message

                // Call API to update status
                sendStatusUpdate(docType, 'Rejected', subject, message);
            });

            // Function to send status update to the API
            function sendStatusUpdate(docType, status, subject, message) {
                var payload = {
                    ImageStatus: docType + "Status",
                    subject: subject,
                    message: message,
                    id: id // Send the user ID as well
                };
             
                var ApiUrl
                if (status == 'Rejected') { ApiUrl = `${BaseUrl}` + 'Api/Admin/RejectJyotishDocs' }
                else { ApiUrl = `${BaseUrl}` + 'Api/Admin/ApproveJyotishDocs' }
               
                $.ajax({
                    url: ApiUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem("Token")}`
                    },
                    success: function (response) {
                       
                        if (response.status === 200) {
                            Swal.fire({
                                title: "Status updated successfully!",
                             
                                icon: "success",

                                showConfirmButton: true, // Ensure the OK button is shown
                            });
                            
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                       
                        alert('Error updating document status.');
                    }
                });
            }
        } else {
            alert('ID parameter is missing in the URL.');
        }
    });

</script>

